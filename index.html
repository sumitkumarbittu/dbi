<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postgres File Injector</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üêò Postgres File Injector</h1>
            <div class="status-badge" id="statusBadge">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="statusText">Render: Disconnected</span>
            </div>

            <!-- API Selection -->
            <div class="api-selector" id="apiSelector">
                <div class="api-label">API Base:</div>
                <div class="api-boxes" id="apiBoxes"></div>
            </div>
            <div id="renderUrlText"></div>
        </div>

        <!-- CARD 1: Target Database Connection -->
        <div class="card" id="card-target-db">
            <div class="card-title">üîå Target Database Connection</div>
            <div class="input-group" id="dbUrlGroup">
                <label>Target PostgreSQL Connection URL</label>
                <div id="dbUrlDisplay" class="hidden">
                    <div class="db-url-display">
                        <span id="dbUrlText">Not configured</span>
                        <button class="btn btn-icon btn-secondary" onclick="editDbUrl()">‚úèÔ∏è</button>
                    </div>
                </div>
                <div class="input-wrapper" id="dbUrlInput">
                    <input type="text" id="dbUrl" placeholder="postgresql://user:password@host:port/database">
                    <button class="btn btn-primary" onclick="saveDbConnection()">üíæ Save</button>
                </div>
            </div>
            <div id="targetDbStatus" class="connection-status hidden">
                <div class="status-indicator connected">
                    <span class="status-icon">‚úì</span>
                    <span id="targetDbStatusText">Connected to target database</span>
                </div>
            </div>
        </div>

        <!-- CARD 2: Data Source (DB/CSV/JSON) with Advanced Preview -->
        <div class="card" id="card-data-source">
            <div class="card-title">üì• Data Source Loader</div>
            
            <!-- Source Type Toggler -->
            <div class="source-toggler">
                <div class="source-label">Select Source:</div>
                <div class="source-options">
                    <button class="source-btn active" id="btnSourceDb" onclick="setSourceType('db')">üóÑÔ∏è Database</button>
                    <button class="source-btn" id="btnSourceCsv" onclick="setSourceType('csv')">üìÑ CSV</button>
                    <button class="source-btn" id="btnSourceJson" onclick="setSourceType('json')">üìã JSON</button>
                </div>
            </div>

            <!-- DB Source Section -->
            <div id="dbSourceSection" class="source-section">
                <div class="input-group">
                    <label>Source Database URL</label>
                    <div class="input-wrapper">
                        <input type="text" id="sourceDbUrl" placeholder="postgresql://user:password@host:port/database">
                        <button class="btn btn-primary" id="connectSourceDbBtn" onclick="connectSourceDb(event)">üîó Connect</button>
                    </div>
                </div>

                <div id="sourceDbStatus" class="connection-status hidden">
                    <div class="status-indicator connected">
                        <span class="status-icon">‚úì</span>
                        <span id="sourceDbStatusText">Connected</span>
                    </div>
                </div>

                <div class="input-group" id="querySection">
                    <label>SQL Query</label>
                    <textarea id="sourceDbQuery" placeholder="SELECT * FROM users LIMIT 100;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="executeSourceQuery()" id="executeQueryBtn" disabled>‚ñ∂Ô∏è Execute Query</button>

                <!-- Advanced Query Results Preview -->
                <div id="queryResultsSection" class="hidden advanced-preview-section">
                    <div class="preview-header">
                        <div>
                            <strong>üìä Query Results Preview</strong>
                            <div class="preview-stats">
                                <span id="queryResultCount">0 rows</span>
                                <span id="queryResultColumns">0 columns</span>
                            </div>
                        </div>
                        <div class="preview-actions">
                            <button class="btn btn-secondary" onclick="selectAllQueryRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearQuerySelection()">Clear</button>
                        </div>
                    </div>
                    <div class="query-results-container">
                        <table class="preview-table" id="queryResultsTable"></table>
                    </div>
                </div>
            </div>

            <!-- CSV Source Section -->
            <div id="csvSourceSection" class="source-section hidden">
                <div class="upload-zone" id="csvUploadZone" onclick="document.getElementById('csvFileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop CSV file here or click to browse</h3>
                    <p class="upload-subtitle">Supports CSV files with advanced preview</p>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCsvFileSelect(event)">

                <div id="csvFileInfoSection" class="hidden">
                    <div class="file-info">
                        <div class="file-meta">
                            <strong>üìÑ Selected:</strong> <span id="csvFileName"></span>
                            <div class="file-stats">
                                <span id="csvFileSize"></span>
                                <span id="csvRowCount"></span>
                                <span id="csvColCount"></span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-danger" onclick="clearCsvSource()">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>

                <div class="preview-card hidden" id="csvPreviewCard">
                    <div class="preview-header">
                        <div>
                            <strong>CSV Preview</strong>
                            <div class="preview-stats">
                                Showing <span id="csvPreviewRange">1-10</span>
                                <span id="csvSelectedCounter" class="selected-counter hidden">| <span id="csvSelectedCount">0</span> selected</span>
                            </div>
                        </div>
                        <div class="preview-actions">
                            <button class="btn btn-secondary btn-sm" id="csvPreviewToggleBtn" onclick="toggleCsvPreviewMode()">Raw</button>
                            <button class="btn btn-secondary btn-sm" onclick="selectAllCsvRows()">Select All</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearCsvSelection()">Clear</button>
                            <button class="btn btn-secondary btn-sm" onclick="csvPreviewPrev()">‚Üê</button>
                            <button class="btn btn-secondary btn-sm" onclick="csvPreviewNext()">‚Üí</button>
                        </div>
                    </div>
                    <div class="mapping-section" id="csvMappingSection">
                        <label>Attribute Mapping</label>
                        <div class="section-subtitle">Map CSV columns to target table attributes</div>
                        <div id="csvMappingRows"></div>
                    </div>
                    <div class="table-scroll-container">
                        <table class="preview-table" id="csvPreviewTable"></table>
                    </div>
                </div>
            </div>

            <!-- JSON Source Section -->
            <div id="jsonSourceSection" class="source-section hidden">
                <div class="upload-zone" id="jsonUploadZone" onclick="document.getElementById('jsonFileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop JSON file here or click to browse</h3>
                    <p class="upload-subtitle">Supports JSON files with advanced preview</p>
                </div>
                <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJsonFileSelect(event)">

                <div id="jsonFileInfoSection" class="hidden">
                    <div class="file-info">
                        <div class="file-meta">
                            <strong>üìã Selected:</strong> <span id="jsonFileName"></span>
                            <div class="file-stats">
                                <span id="jsonFileSize"></span>
                                <span id="jsonObjectCount"></span>
                                <span id="jsonKeyCount"></span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-danger" onclick="clearJsonSource()">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>

                <div class="preview-card hidden" id="jsonPreviewCard">
                    <div class="preview-header">
                        <div>
                            <strong>JSON Preview</strong>
                            <div class="preview-stats">
                                Showing <span id="jsonPreviewRange">1-10</span>
                                <span id="jsonSelectedCounter" class="selected-counter hidden">| <span id="jsonSelectedCount">0</span> selected</span>
                            </div>
                        </div>
                        <div class="preview-actions">
                            <button class="btn btn-secondary btn-sm" id="jsonPreviewToggleBtn" onclick="toggleJsonPreviewMode()">Raw</button>
                            <button class="btn btn-secondary btn-sm" onclick="selectAllJsonRows()">Select All</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearJsonSelection()">Clear</button>
                            <button class="btn btn-secondary btn-sm" onclick="jsonPreviewPrev()">‚Üê</button>
                            <button class="btn btn-secondary btn-sm" onclick="jsonPreviewNext()">‚Üí</button>
                        </div>
                    </div>
                    <div class="mapping-section" id="jsonMappingSection">
                        <label>Attribute Mapping</label>
                        <div class="section-subtitle">Map JSON keys to target table attributes</div>
                        <div id="jsonMappingRows"></div>
                    </div>
                    <div class="table-scroll-container">
                        <table class="preview-table" id="jsonPreviewTable"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 3: Create Table -->
        <div class="card" id="card-create-table">
            <div class="card-title" style="justify-content: space-between;">
                <span>‚ö° Create Table</span>
                <button class="btn btn-secondary btn-sm" onclick="toggleCreateTableCard()"><span id="createTableToggleBtnText">Create Table</span></button>
            </div>
            <div id="createTableBody" class="hidden">
                <div class="input-group">
                    <label>SQL Schema Definition</label>
                    <textarea id="createTableSql" placeholder="CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="executeCreateTable()">‚ö° Create</button>
                </div>
            </div>
        </div>

        <!-- CARD 4: Table Schema Info -->
        <div class="card" id="card-table-schema">
            <div class="card-title">üìä Target Table Schema</div>
            <div class="input-group">
                <label>Table Name</label>
                <div class="input-wrapper">
                    <input type="text" id="tableName" placeholder="Enter table name">
                    <button class="btn btn-primary" onclick="fetchTableSchema()">üîç Load Schema</button>
                </div>
            </div>

            <div class="schema-display hidden" id="schemaInfo">
                <div class="schema-header">
                    <h4 id="schemaTableName">-</h4>
                    <span class="schema-badge" id="schemaStatus">Not Loaded</span>
                </div>
                <div class="info-grid">
                    <div class="info-box primary">
                        <label>üîë Primary Key</label>
                        <div class="value" id="primaryKey">-</div>
                    </div>
                    <div class="info-box">
                        <label>üìã Total Attributes</label>
                        <div class="value" id="attributesCount">-</div>
                    </div>
                </div>
                <div class="attributes-list">
                    <label>üìë All Attributes</label>
                    <div class="attributes-tags" id="attributes">-</div>
                </div>
            </div>
        </div>

        <!-- CARD 5: Verify & Advanced Mapping -->
        <div class="card hidden" id="card-mapping">
            <div class="card-title">üîÑ Attribute Mapping & Verification</div>
            <div class="mapping-info">
                <div class="mapping-source">
                    <strong>Source:</strong> <span id="mappingSourceName">-</span>
                </div>
                <div class="mapping-target">
                    <strong>Target:</strong> <span id="mappingTargetTable">-</span>
                </div>
            </div>
            
            <div class="mapping-section" id="advancedMappingSection">
                <div class="mapping-header">
                    <div>Source Field</div>
                    <div>Target Attribute</div>
                    <div>Action</div>
                </div>
                <div id="advancedMappingRows"></div>
            </div>

            <div class="mapping-validation" id="mappingValidation">
                <div class="validation-status" id="validationStatus">
                    <span class="status-icon">‚ö†Ô∏è</span>
                    <span>No mappings configured</span>
                </div>
            </div>

            <div class="mapping-controls">
                <button class="btn btn-secondary" onclick="clearAllMappings()">üóëÔ∏è Clear All</button>
                <button class="btn btn-secondary" onclick="previewMapping()">üëÅÔ∏è Preview Result</button>
            </div>
        </div>

        <!-- CARD 6: Source/Matched Preview -->
        <div class="card hidden" id="card-preview">
            <div class="preview-tabs">
                <button class="preview-tab active" onclick="setPreviewTab('source')" id="tabSource">üìÑ Source Preview</button>
                <button class="preview-tab" onclick="setPreviewTab('matched')" id="tabMatched">‚úÖ Matched Preview</button>
            </div>

            <!-- Source Preview Panel -->
            <div id="sourcePreviewPanel" class="preview-panel active">
                <div class="preview-controls">
                    <div class="preview-stats-bar">
                        <span id="sourcePreviewStats">Showing 1-10 of 0 rows</span>
                        <span id="sourceSelectedStats">0 selected</span>
                    </div>
                    <div class="preview-buttons">
                        <button class="btn btn-secondary" onclick="selectAllPreviewRows()">Select All</button>
                        <button class="btn btn-secondary" onclick="clearPreviewSelection()">Clear</button>
                        <button class="btn btn-secondary" onclick="previewPrev()">‚Üê Prev</button>
                        <button class="btn btn-secondary" onclick="previewNext()">Next ‚Üí</button>
                    </div>
                </div>
                <div class="preview-table-container">
                    <table class="preview-table" id="advancedPreviewTable"></table>
                </div>
            </div>

            <!-- Matched Preview Panel -->
            <div id="matchedPreviewPanel" class="preview-panel hidden">
                <div class="preview-controls">
                    <div class="preview-stats-bar">
                        <span id="matchedPreviewStats">Showing matched data</span>
                        <span class="match-badge" id="matchRate">0% matched</span>
                    </div>
                </div>
                <div class="preview-table-container">
                    <table class="preview-table" id="matchedPreviewTable"></table>
                </div>
            </div>

            <div class="preview-actions-footer">
                <button class="btn btn-primary btn-large" onclick="uploadToDatabase()" id="uploadBtn">
                    üöÄ Upload to Database
                </button>
            </div>
        </div>

        <!-- CARD 7: Uploads & Job Status with Search -->
        <div class="card" id="card-uploads">
            <div class="card-title" style="justify-content: space-between;">
                <span>üì§ Uploads & Job Status</span>
                <button class="btn btn-secondary btn-sm" onclick="refreshRecentJobs()">üîÑ Refresh</button>
            </div>
            
            <!-- Job Search -->
            <div class="job-search-section">
                <div class="input-wrapper">
                    <input type="text" id="jobSearchInput" placeholder="Search by Job ID..." onkeyup="searchJobs()">
                    <button class="btn btn-secondary" onclick="searchJobs()">üîç Search</button>
                    <button class="btn btn-secondary" onclick="clearJobSearch()">Clear</button>
                </div>
                <div class="job-filters">
                    <button class="filter-btn active" onclick="filterJobs('all')" id="filterAll">All</button>
                    <button class="filter-btn" onclick="filterJobs('processing')" id="filterProcessing">Processing</button>
                    <button class="filter-btn" onclick="filterJobs('completed')" id="filterCompleted">Completed</button>
                    <button class="filter-btn" onclick="filterJobs('failed')" id="filterFailed">Failed</button>
                </div>
            </div>

            <!-- Job Stats -->
            <div class="job-stats-bar">
                <div class="stat-item">
                    <span class="stat-value" id="totalJobs">0</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="processingJobs">0</span>
                    <span class="stat-label">Processing</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="completedJobs">0</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="failedJobs">0</span>
                    <span class="stat-label">Failed</span>
                </div>
            </div>

            <!-- Job Cards Container -->
            <div id="jobCardsContainer" class="job-cards-container">
                <div class="empty-state" id="emptyJobsState">
                    <div class="empty-icon">üì≠</div>
                    <p>No active uploads</p>
                    <p class="empty-subtitle">Upload data to see job status here</p>
                </div>
            </div>
        </div>

    <script src="script.js"></script>
    <script src="track.js"></script>
</body>

</html>