<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postgres File Injector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"],
        input[type="url"],
        textarea {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 150px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-icon {
            padding: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-box label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .info-box .value {
            font-family: 'Courier New', monospace;
            color: #1f2937;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .upload-zone {
            border: 3px dashed #d1d5db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f9fafb;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #eef2ff;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #eef2ff;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        .schema-section {
            margin-top: 15px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .job-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .job-status.completed {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .job-status.failed {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .db-url-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            color: #374151;
            word-break: break-all;
        }

        .api-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .api-label {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .api-boxes {
            display: flex;
            gap: 8px;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
            padding: 2px 0;
            max-width: 100%;
        }

        .api-boxes::-webkit-scrollbar {
            height: 4px;
        }

        .api-boxes::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .api-boxes::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        .api-boxes::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .api-box {
            padding: 8px 50px;
            border-radius: 20px;
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.8);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 120px;
            text-align: center;
            user-select: none;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .api-box:hover {
            background: rgba(255,255,255,0.25);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .api-box.selected {
            background: rgba(255,255,255,0.95);
            color: #667eea;
            box-shadow: 0 4px 16px rgba(255,255,255,0.4);
            font-weight: 700;
            transform: scale(1.05);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #374151;
            margin: 4px 6px 0 0;
        }

        .pill.match {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .pill.mismatch {
            border-color: #ef4444;
            background: #fee2e2;
            color: #7f1d1d;
        }

        .mapping-section {
            margin-top: 16px;
            padding: 15px;
            border-radius: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            margin-top: 10px;
        }

        .mapping-row label {
            margin: 0;
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 700;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 0.95rem;
            font-family: 'Courier New', monospace;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .preview-card {
            margin-top: 12px;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .preview-table th,
        .preview-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
        }

        .preview-table th {
            background: #f9fafb;
            position: sticky;
            top: 0;
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
            }

            .card {
                padding: 18px;
                border-radius: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .api-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 12px;
            }

            .api-label {
                text-align: center;
            }

            .api-boxes {
                justify-content: flex-start;
                gap: 6px;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 4px;
            }

            .api-box {
                padding: 10px 40px;
                font-size: 0.95rem;
                min-width: 100px;
            }

            .input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .mapping-row {
                grid-template-columns: 1fr;
            }

            .file-info {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .db-url-display {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêò Postgres File Injector</h1>
            <div class="status-badge" id="statusBadge">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="statusText">Render: Disconnected</span>
            </div>
            
            <!-- API Selection -->
            <div class="api-selector" id="apiSelector">
                <div class="api-label">API Base:</div>
                <div class="api-boxes" id="apiBoxes"></div>
            </div>
        </div>

        <!-- Database Connection -->
        <div class="card">
            <div class="card-title">üîå Database Connection</div>
            <div class="input-group">
                <label>Render API URL</label>
                <div class="db-url-display">
                    <span id="renderUrlText">Select an API base above</span>
                </div>
            </div>
            <div class="input-group" id="dbUrlGroup">
                <label>PostgreSQL Connection URL</label>
                <div id="dbUrlDisplay" class="hidden">
                    <div class="db-url-display">
                        <span id="dbUrlText">Not configured</span>
                        <button class="btn btn-icon btn-secondary" onclick="editDbUrl()">‚úèÔ∏è</button>
                    </div>
                </div>
                <div class="input-wrapper" id="dbUrlInput">
                    <input type="text" id="dbUrl" placeholder="postgresql://user:password@host:port/database">
                    <button class="btn btn-primary" onclick="saveDbConnection()">üíæ Save</button>
                </div>
            </div>
        </div>

        <!-- Create Table -->
        <div class="card">
            <div class="card-title">
                üìã Table Management
                <button class="btn btn-secondary" style="margin-left: auto;" onclick="toggleCreateTable()">
                    <span id="createTableBtnText">‚ûï Create Table</span>
                </button>
            </div>
            
            <div class="schema-section hidden" id="schemaSection">
                <div class="input-group">
                    <label>SQL Schema</label>
                    <textarea id="createTableSql" placeholder="CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE
);"></textarea>
                </div>
                <button class="btn btn-primary" onclick="executeCreateTable()">‚ö° Execute</button>
            </div>
        </div>

        <!-- Table Schema Info -->
        <div class="card">
            <div class="card-title">üìä Table Schema</div>
            <div class="input-group">
                <label>Table Name</label>
                <div class="input-wrapper">
                    <input type="text" id="tableName" placeholder="users">
                    <button class="btn btn-primary" onclick="fetchTableSchema()">üîç Set</button>
                </div>
            </div>
            
            <div class="info-grid" id="schemaInfo" style="display: none;">
                <div class="info-box">
                    <label>Primary Key</label>
                    <div class="value" id="primaryKey">-</div>
                </div>
                <div class="info-box">
                    <label>Attributes</label>
                    <div class="value" id="attributes">-</div>
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="card hidden" id="uploadCard">
            <div class="card-title">üì§ Upload Data</div>
            
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <h3>Drop your file here or click to browse</h3>
                <p style="color: #6b7280; margin-top: 10px;">Supports CSV and JSON files</p>
            </div>
            
            <input type="file" id="fileInput" accept=".csv,.json" style="display: none;" onchange="handleFileSelect(event)">
            
            <div id="fileInfoSection" class="hidden">
                <div class="file-info">
                    <div>
                        <strong>Selected:</strong> <span id="fileName"></span>
                        <div style="color: #6b7280; font-size: 0.9rem; margin-top: 5px;">
                            <span id="fileSize"></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-secondary" onclick="verifyFile()">‚úÖ Verify</button>
                        <button class="btn btn-primary" onclick="uploadFile()">üöÄ Upload</button>
                    </div>
                </div>

                <div class="mapping-section hidden" id="mappingSection">
                    <div style="font-weight: 800; color: #1f2937;">Attribute Mapping</div>
                    <div style="color: #6b7280; font-size: 0.9rem; margin-top: 6px;">
                        Table attributes are fixed. Select the CSV column to map into each table attribute.
                    </div>
                    <div id="mappingRows"></div>
                </div>

                <div class="preview-card hidden" id="previewCard">
                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                        <div>
                            <div style="font-weight: 800; color: #1f2937;">CSV Preview</div>
                            <div style="color: #6b7280; font-size: 0.9rem; margin-top: 4px;">
                                Showing <span id="previewRange">1-10</span>
                            </div>
                        </div>
                        <div style="display:flex; gap: 10px;">
                            <button class="btn btn-secondary" id="previewToggleBtn" onclick="togglePreviewMode()">Matched</button>
                            <button class="btn btn-secondary" onclick="previewPrev()">-10</button>
                            <button class="btn btn-secondary" onclick="previewNext()">+10</button>
                        </div>
                    </div>
                    <div style="max-height: 280px; overflow: auto; border-radius: 10px;">
                        <table class="preview-table" id="previewTable"></table>
                    </div>
                </div>
            </div>

            <div id="jobStatusSection" class="hidden"></div>
        </div>
    </div>

    <script>
        const API_CONFIGS = {
            'A': 'https://dbi.onrender.com',
            'B': 'https://dbi-2xer.onrender.com',
            'C': 'https://dbi2.onrender.com'
        };
        let selectedApi = 'B';
        let currentDbUrl = '';
        let tableSchema = null;
        let selectedFile = null;
        let csvHeader = [];
        let csvRows = [];
        let previewOffset = 0;
        let columnMapping = {};
        let previewMode = 'matched'; // 'matched' | 'raw'

        // Check Render connection
        async function checkRenderConnection() {
            const selectedConfig = API_CONFIGS[selectedApi];
            renderApiUrl = selectedConfig;
            
            try {
                const res = await fetch(`${renderApiUrl}/health`);
                if (res.ok) {
                    updateStatus(true);
                } else {
                    updateStatus(false);
                }
            } catch (err) {
                updateStatus(false);
            }
        }

        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = 'Render: Connected';
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'Render: Disconnected';
            }
        }

        // Save DB connection
        async function saveDbConnection() {
            const url = document.getElementById('dbUrl').value.trim();
            if (!url) {
                showNotification('Please enter a database URL', 'error');
                return;
            }

            try {
                const res = await fetch(`${renderApiUrl}/save-db`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ database_url: url })
                });

                if (res.ok) {
                    currentDbUrl = url;
                    document.getElementById('dbUrlText').textContent = maskUrl(url);
                    document.getElementById('dbUrlDisplay').classList.remove('hidden');
                    document.getElementById('dbUrlInput').classList.add('hidden');
                    showNotification('Database connection saved!', 'success');
                } else {
                    showNotification('Failed to save connection', 'error');
                }
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            }
        }

        function editDbUrl() {
            document.getElementById('dbUrlDisplay').classList.add('hidden');
            document.getElementById('dbUrlInput').classList.remove('hidden');
            document.getElementById('dbUrl').value = currentDbUrl;
        }

        function maskUrl(url) {
            try {
                const parsed = new URL(url);
                return `${parsed.protocol}//${parsed.username}:***@${parsed.host}${parsed.pathname}`;
            } catch {
                return url.substring(0, 30) + '...';
            }
        }

        // Toggle create table section
        function toggleCreateTable() {
            const section = document.getElementById('schemaSection');
            const btnText = document.getElementById('createTableBtnText');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                btnText.textContent = '‚úñÔ∏è Cancel';
            } else {
                section.classList.add('hidden');
                btnText.textContent = '‚ûï Create Table';
            }
        }

        // Execute create table
        async function executeCreateTable() {
            const sql = document.getElementById('createTableSql').value.trim();
            if (!sql) {
                showNotification('Please enter SQL schema', 'error');
                return;
            }

            try {
                const res = await fetch(`${renderApiUrl}/create-table`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ create_sql: sql })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification('Table created successfully!', 'success');
                    toggleCreateTable();
                    document.getElementById('createTableSql').value = '';
                } else {
                    showNotification('Error: ' + errorToString(data.detail), 'error');
                }
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            }
        }

        // Fetch table schema
        async function fetchTableSchema() {
            const table = document.getElementById('tableName').value.trim();
            if (!table) {
                showNotification('Please enter a table name', 'error');
                return;
            }

            try {
                const res = await fetch(`${renderApiUrl}/table-schema?table=${table}`);
                const data = await res.json();
                
                if (res.ok) {
                    tableSchema = data;
                    document.getElementById('primaryKey').textContent = data.primary_key.join(', ') || 'None';
                    document.getElementById('attributes').textContent = data.attributes.join(', ');
                    document.getElementById('schemaInfo').style.display = 'grid';
                    document.getElementById('uploadCard').classList.remove('hidden');

                    selectedFile = null;
                    csvHeader = [];
                    csvRows = [];
                    previewOffset = 0;
                    columnMapping = {};
                    document.getElementById('fileInfoSection').classList.add('hidden');
                    document.getElementById('fileInput').value = '';
                    document.getElementById('jobStatusSection').classList.add('hidden');
                    document.getElementById('mappingSection').classList.add('hidden');
                    document.getElementById('previewCard').classList.add('hidden');
                    showNotification('Schema loaded!', 'success');
                } else {
                    tableSchema = null;
                    document.getElementById('schemaInfo').style.display = 'none';
                    document.getElementById('uploadCard').classList.add('hidden');
                    showNotification('Error: ' + errorToString(data.detail), 'error');
                }
            } catch (err) {
                tableSchema = null;
                document.getElementById('schemaInfo').style.display = 'none';
                document.getElementById('uploadCard').classList.add('hidden');
                showNotification('Error: ' + err.message, 'error');
            }
        }

        function parseCsvLine(line) {
            const out = [];
            let cur = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (inQuotes) {
                    if (ch === '"') {
                        if (line[i + 1] === '"') {
                            cur += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        cur += ch;
                    }
                } else {
                    if (ch === ',') {
                        out.push(cur);
                        cur = '';
                    } else if (ch === '"') {
                        inQuotes = true;
                    } else {
                        cur += ch;
                    }
                }
            }
            out.push(cur);
            return out;
        }

        function csvEscape(value) {
            const v = value == null ? '' : String(value);
            if (v.includes('"') || v.includes(',') || v.includes('\n') || v.includes('\r')) {
                return '"' + v.replaceAll('"', '""') + '"';
            }
            return v;
        }

        function buildMappingUI() {
            const section = document.getElementById('mappingSection');
            const rowsEl = document.getElementById('mappingRows');
            rowsEl.innerHTML = '';

            if (!tableSchema || !Array.isArray(tableSchema.attributes) || tableSchema.attributes.length === 0) {
                section.classList.add('hidden');
                return;
            }

            if (!csvHeader || csvHeader.length === 0) {
                section.classList.add('hidden');
                return;
            }

            // Default mapping = same name if present, else keep empty
            const headerSet = new Set(csvHeader);
            for (const attr of tableSchema.attributes) {
                if (columnMapping[attr] === undefined) {
                    columnMapping[attr] = headerSet.has(attr) ? attr : '';
                }
            }

            for (const attr of tableSchema.attributes) {
                const mapped = columnMapping[attr] ?? '';
                const isMatch = mapped && mapped === attr;
                const isMapped = Boolean(mapped);

                const row = document.createElement('div');
                row.className = 'mapping-row';

                const left = document.createElement('div');
                left.innerHTML = `
                    <div style="display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                        <span class="pill">${attr}</span>
                        <span class="pill ${isMapped ? (isMatch ? 'match' : 'mismatch') : 'mismatch'}">
                            ${isMapped ? mapped : 'keep empty'}
                        </span>
                    </div>
                    <div style="margin-top:6px;">
                        <label>Table attribute</label>
                    </div>
                `;

                const right = document.createElement('div');
                const select = document.createElement('select');
                select.dataset.tableAttr = attr;

                const optEmpty = document.createElement('option');
                optEmpty.value = '';
                optEmpty.textContent = 'keep empty';
                select.appendChild(optEmpty);

                const optAuto = document.createElement('option');
                optAuto.value = '__AUTO__';
                optAuto.textContent = 'auto-generate';
                select.appendChild(optAuto);

                for (const h of csvHeader) {
                    const opt = document.createElement('option');
                    opt.value = h;
                    opt.textContent = h;
                    select.appendChild(opt);
                }
                select.value = mapped;
                select.addEventListener('change', (e) => {
                    columnMapping[attr] = e.target.value;
                    buildMappingUI();
                });
                right.appendChild(select);

                row.appendChild(left);
                row.appendChild(right);
                rowsEl.appendChild(row);
            }

            section.classList.remove('hidden');
        }

        function renderPreview() {
            const card = document.getElementById('previewCard');
            const table = document.getElementById('previewTable');

            if (!csvHeader || csvHeader.length === 0 || !csvRows) {
                card.classList.add('hidden');
                return;
            }

            const toggleBtn = document.getElementById('previewToggleBtn');
            if (toggleBtn) {
                toggleBtn.textContent = previewMode === 'raw' ? 'CSV' : 'Matched';
            }

            const start = previewOffset;
            const end = Math.min(previewOffset + 10, csvRows.length);
            document.getElementById('previewRange').textContent = `${start + 1}-${end}`;

            if (previewMode === 'raw') {
                const headerHtml = `<tr>${csvHeader.map(h => `<th>${h}</th>`).join('')}</tr>`;
                const bodyHtml = csvRows.slice(start, end).map(r => {
                    return `<tr>${csvHeader.map((_, idx) => `<td>${(r[idx] ?? '')}</td>`).join('')}</tr>`;
                }).join('');
                table.innerHTML = `<thead>${headerHtml}</thead><tbody>${bodyHtml}</tbody>`;
                card.classList.remove('hidden');
                return;
            }

            // matched/mapped preview
            if (!tableSchema || !Array.isArray(tableSchema.attributes) || tableSchema.attributes.length === 0) {
                card.classList.add('hidden');
                return;
            }

            const mappedTableAttrs = tableSchema.attributes.filter(a => {
                const m = columnMapping[a];
                return m && m !== '' && m !== '__AUTO__';
            });

            if (mappedTableAttrs.length === 0) {
                card.classList.add('hidden');
                return;
            }

            const idxByCsv = {};
            csvHeader.forEach((h, i) => { idxByCsv[h] = i; });

            const headerHtml = `<tr>${mappedTableAttrs.map(h => `<th>${h}</th>`).join('')}</tr>`;
            const bodyHtml = csvRows.slice(start, end).map(r => {
                return `<tr>${mappedTableAttrs.map((attr) => {
                    const mapped = columnMapping[attr];
                    const idx = idxByCsv[mapped];
                    return `<td>${(idx === undefined ? '' : (r[idx] ?? ''))}</td>`;
                }).join('')}</tr>`;
            }).join('');

            table.innerHTML = `<thead>${headerHtml}</thead><tbody>${bodyHtml}</tbody>`;
            card.classList.remove('hidden');
        }

        function togglePreviewMode() {
            previewMode = previewMode === 'raw' ? 'matched' : 'raw';
            renderPreview();
        }

        function previewNext() {
            if (!csvRows || csvRows.length === 0) return;
            previewOffset = Math.min(previewOffset + 10, Math.max(csvRows.length - 1, 0));
            renderPreview();
        }

        function previewPrev() {
            if (!csvRows || csvRows.length === 0) return;
            previewOffset = Math.max(previewOffset - 10, 0);
            renderPreview();
        }

        async function verifyFile() {
            if (!selectedFile) {
                showNotification('No file selected', 'error');
                return;
            }
            if (!tableSchema) {
                showNotification('Please set table schema first', 'error');
                return;
            }
            if (!selectedFile.name.endsWith('.csv')) {
                showNotification('Verify supports CSV preview only', 'error');
                return;
            }

            try {
                const text = await selectedFile.text();
                const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.length > 0);
                if (lines.length === 0) {
                    showNotification('CSV file is empty', 'error');
                    return;
                }
                csvHeader = parseCsvLine(lines[0]).map(s => s.trim()).filter(Boolean);
                csvRows = lines.slice(1).map(parseCsvLine);
                previewOffset = 0;
                previewMode = 'matched';

                buildMappingUI();
                renderPreview();
                showNotification('CSV verified!', 'success');
            } catch (err) {
                showNotification('Verify error: ' + err.message, 'error');
            }
        }

        // File handling
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.endsWith('.csv') && !file.name.endsWith('.json')) {
                showNotification('Only CSV and JSON files are supported', 'error');
                return;
            }

            selectedFile = file;
            csvHeader = [];
            csvRows = [];
            previewOffset = 0;
            columnMapping = {};
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            document.getElementById('fileInfoSection').classList.remove('hidden');
            document.getElementById('mappingSection').classList.add('hidden');
            document.getElementById('previewCard').classList.add('hidden');
        }

        async function uploadFile() {
            if (!selectedFile) {
                showNotification('No file selected', 'error');
                return;
            }

            if (!tableSchema) {
                showNotification('Please set table schema first', 'error');
                return;
            }

            if (!renderApiUrl) {
                showNotification('Please set Render API URL first', 'error');
                return;
            }

            if (!Array.isArray(tableSchema.attributes) || tableSchema.attributes.length === 0) {
                showNotification('Table attributes not loaded', 'error');
                return;
            }

            if (!Array.isArray(tableSchema.primary_key) || tableSchema.primary_key.length === 0) {
                showNotification('Table primary key not loaded', 'error');
                return;
            }

            // For CSV, require verify + mapping
            if (selectedFile.name.endsWith('.csv')) {
                if (!csvHeader || csvHeader.length === 0) {
                    showNotification('Click Verify to load CSV header and preview first', 'error');
                    return;
                }

                // PK can be auto-generated. If user maps PK, keep it; otherwise we'll omit it and send empty primary_key.

                // Build transformed CSV with headers as mapped table attributes (excluding keep empty)
                const includedTableAttrs = tableSchema.attributes.filter(a => columnMapping[a] && columnMapping[a] !== '__AUTO__');
                const outHeader = includedTableAttrs;

                const idxByCsv = {};
                csvHeader.forEach((h, i) => { idxByCsv[h] = i; });

                const outLines = [];
                outLines.push(outHeader.map(csvEscape).join(','));

                for (const row of csvRows) {
                    const outRow = outHeader.map(attr => {
                        const mapped = columnMapping[attr];
                        const idx = idxByCsv[mapped];
                        return csvEscape(idx === undefined ? '' : (row[idx] ?? ''));
                    });
                    outLines.push(outRow.join(','));
                }

                const blob = new Blob([outLines.join('\n')], { type: 'text/csv' });
                selectedFile = new File([blob], selectedFile.name, { type: 'text/csv' });
            }

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('table', tableSchema.table);
            if (selectedFile.name.endsWith('.csv')) {
                const includedTableAttrs = tableSchema.attributes.filter(a => columnMapping[a] && columnMapping[a] !== '__AUTO__');
                formData.append('columns', includedTableAttrs.join(','));
            } else {
                formData.append('columns', tableSchema.attributes.join(','));
            }

            if (selectedFile.name.endsWith('.csv')) {
                const mappedPk = (tableSchema.primary_key || []).filter(pk => columnMapping[pk] && columnMapping[pk] !== '__AUTO__');
                formData.append('primary_key', mappedPk.join(','));
            } else {
                formData.append('primary_key', tableSchema.primary_key.join(','));
            }

            try {
                const res = await fetch(`${renderApiUrl}/upload-data`, {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification('Upload started!', 'info');
                    monitorJob(data.job_id);
                } else {
                    showNotification('Error: ' + errorToString(data.detail), 'error');
                }
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            }
        }

        async function monitorJob(jobId) {
            const section = document.getElementById('jobStatusSection');
            section.classList.remove('hidden');
            section.innerHTML = `
                <div class="job-status">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="spinner"></div>
                        <strong>Processing upload...</strong>
                    </div>
                </div>
            `;

            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`${renderApiUrl}/job-status/${jobId}`);
                    const job = await res.json();

                    if (job.status === 'completed') {
                        clearInterval(interval);
                        section.innerHTML = `
                            <div class="job-status completed">
                                <strong>‚úÖ Upload Complete!</strong>
                                <div style="margin-top: 10px; font-size: 0.9rem;">
                                    Total rows: ${job.rows_total} | 
                                    Inserted: ${job.rows_inserted} | 
                                    Skipped: ${job.rows_skipped}
                                </div>
                            </div>
                        `;
                        showNotification('File uploaded successfully!', 'success');
                    } else if (job.status === 'failed') {
                        clearInterval(interval);
                        section.innerHTML = `
                            <div class="job-status failed">
                                <strong>‚ùå Upload Failed</strong>
                                <div style="margin-top: 10px; font-size: 0.9rem;">${job.error}</div>
                            </div>
                        `;
                        showNotification('Upload failed', 'error');
                    }
                } catch (err) {
                    clearInterval(interval);
                    showNotification('Error checking job status', 'error');
                }
            }, 2000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize API selector
        function initializeApiSelector() {
            const container = document.getElementById('apiBoxes');
            container.innerHTML = '';
            
            Object.keys(API_CONFIGS).forEach(key => {
                const box = document.createElement('div');
                box.className = `api-box ${key === selectedApi ? 'selected' : ''}`;
                box.textContent = key;
                box.onclick = () => selectApi(key);
                container.appendChild(box);
            });
        }
        
        function selectApi(key) {
            selectedApi = key;
            document.querySelectorAll('.api-box').forEach(box => {
                box.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Update the display text
            document.getElementById('renderUrlText').textContent = API_CONFIGS[key];
            
            checkRenderConnection();
        }
        
        // Auto-check connection on load
        setTimeout(() => {
            initializeApiSelector();
            checkRenderConnection();
        }, 500);

        function errorToString(detail) {
        if (typeof detail === 'string') return detail;
        if (detail?.error) return detail.error;
        return JSON.stringify(detail);
        }
    </script>
</body>
</html>